<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>🧙 RPG Observer Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #playerGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .playerCell {
      background: #2d3748;
      border-radius: 0.5rem;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 100px;
      position: relative;
      transition: background-color 0.5s ease;
    }

    .playerCell.attack {
      background-color: #991b1b;
      /* kırmızı tonları */
    }

    .playerCell.defense {
      background-color: #1e40af;
      /* mavi tonları */
    }

    .playerCell.heal {
      background-color: #166534;
      /* yeşil tonları */
    }

    .playerInfo,
    .enemyInfo {
      width: 48%;
    }

    .stats div {
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    /* Hasar popup */
    .damage-popup {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      font-weight: bold;
      color: #f87171;
      /* kırmızı-400 */
      opacity: 0;
      pointer-events: none;
      transition: all 0.8s ease-out;
      user-select: none;
      z-index: 10;
      text-shadow: 0 0 5px black;
    }

    .damage-popup.show {
      top: -20px;
      opacity: 1;
    }

    /* Kayan yazı */
    .scroll-text {
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }

    .scroll-text span {
      display: inline-block;
      padding-left: 100%;
      animation: scroll 8s linear infinite;
    }

    @keyframes scroll {
      from {
        transform: translateX(0);
      }

      to {
        transform: translateX(-100%);
      }
    }
  </style>
</head>

<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-4xl font-extrabold mb-6">🧙 Oynuyoruz Panel</h1>

    <section class="mb-6 p-4 bg-gray-800 rounded shadow font-mono">
      <div class="flex justify-between items-center gap-4 flex-wrap">

        <div class="flex flex-col items-center">
          <span class="text-xs text-gray-400">Durum</span>
          <div class="flex items-center gap-1 text-lg">
            🎮 <span id="gameStatus"></span>
          </div>
        </div>

        <div class="flex flex-col items-center">
          <span class="text-xs text-gray-400">Tur</span>
          <div class="flex items-center gap-1 text-lg">
            🔄 <span id="turnNumber"></span>
          </div>
        </div>

        <div class="flex flex-col items-center">
          <span class="text-xs text-gray-400">Süre</span>
          <div class="flex items-center gap-1 text-lg">
            ⏳ <span id="turnTimer"></span>
          </div>
        </div>

        <div class="flex flex-col items-center">
          <span class="text-xs text-gray-400">Kat</span>
          <div class="flex items-center gap-1 text-lg">
            🗺️ <span id="dungeonFloor"></span>
          </div>
        </div>

      </div>
    </section>

    <section class="mb-6">
      <h2 class="text-2xl font-semibold mb-3">Players vs Enemies</h2>
      <div id="playerGrid"></div>
    </section>

    <section>
      <h2 class="text-2xl font-semibold mb-3">Action Log</h2>
      <div id="log" class="bg-gray-800 p-4 h-48 overflow-y-auto font-mono rounded shadow"></div>
    </section>
  </div>

  <script>
    let actionHistory = {};
    let lastTurnNumber = 0;
    let timerInterval = null;
    const previousHp = {};

    const icons = { hp: '❤️', atk: '⚔️', def: '🛡️' };

    function showDamage(username, amount) {
      const popup = document.getElementById(`damage-${username}`);
      if (!popup) return;

      popup.textContent = `-${amount}`;
      popup.classList.add("show");

      setTimeout(() => {
        popup.classList.remove("show");
        popup.textContent = "";
      }, 800);
    }

    function renderPlayers(players, pairs) {
      const grid = document.getElementById("playerGrid");
      grid.innerHTML = "";

      // Clean actionHistory for removed players
      for (const username in actionHistory) {
        if (!players[username]) delete actionHistory[username];
      }

      // Clean previousHp for removed players
      for (const username in previousHp) {
        if (!players[username]) delete previousHp[username];
      }

      Object.entries(players).forEach(([username, player]) => {
        const pair = pairs?.[username];
        const enemy = pair?.enemy;

        const cell = document.createElement("div");
        cell.className = "playerCell";

        // Arka plan rengini lastAction göre ayarla
        cell.classList.remove("attack", "defense", "heal");
        switch ((player.lastAction || "").toLowerCase()) {
          case "attack":
            cell.classList.add("attack");
            break;
          case "defend":
            cell.classList.add("defense");
            break;
          case "heal":
            cell.classList.add("heal");
            break;
          default:
            break;
        }

        cell.style.position = "relative"; // Hasar popup için

        const playerDiv = document.createElement("div");
        playerDiv.className = "playerInfo";
        playerDiv.innerHTML = `
      <div class="font-semibold text-lg mb-1">${username}</div>
      <div class="stats">
        <div class="text-3xl mb-1">${player.stats.icon || "👹"}</div>
        <div class="font-mono text-lg">${player.class}</div>
        <div class="text-sm mt-1">${icons.hp} ${player.stats.hp} | ${icons.atk} ${player.stats.atk} | ${icons.def} ${player.stats.def}</div>
      </div>
      <div class="mt-2 text-yellow-300 italic text-xs">Action: ${player.lastAction || "Idle"}</div>
      <div class="scroll-text text-xs text-yellow-400 mt-1">
        <span>${player.combatLog || "Waiting for action..."}</span>
      </div>
    `;

        const enemyDiv = document.createElement("div");
        enemyDiv.className = "enemyInfo text-right";

        if (enemy) {
          enemyDiv.innerHTML = `
        <div class="text-3xl mb-1">${enemy.icon || "👹"}</div>
        <div class="font-mono text-lg">${enemy.name}</div>
        <div class="text-sm mt-1">${icons.hp} ${enemy.hp} | ${icons.atk} ${enemy.atk} | ${icons.def} ${enemy.def}</div>
      `;
        } else {
          enemyDiv.innerHTML = `<div class="italic text-gray-400">No Enemy</div>`;
        }

        cell.appendChild(playerDiv);
        cell.appendChild(enemyDiv);

        // Hasar popup elemanı ekle
        const popup = document.createElement("div");
        popup.className = "damage-popup";
        popup.id = `damage-${username}`;
        cell.appendChild(popup);

        grid.appendChild(cell);

        // Hasar kontrolü ve popup gösterimi
        const prevHp = previousHp[username] ?? player.stats.hp;
        if (player.stats.hp < prevHp) {
          showDamage(username, prevHp - player.stats.hp);
        }
        previousHp[username] = player.stats.hp;
      });
    }

    function addLog(message) {
      const logEl = document.getElementById("log");
      const line = document.createElement("div");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function getCurrentRound(state) {
      if (state && state.rounds && state.rounds.length > 0) {
        return state.rounds[state.rounds.length - 1];
      }
      return null;
    }

    function updateGameInfo(state) {
      document.getElementById("gameStatus").textContent = state.status || "Unknown";
      const currentRound = getCurrentRound(state);
      document.getElementById("turnNumber").textContent = currentRound?.turn || 0;
      document.getElementById("dungeonFloor").textContent = state.dungeon?.floor || 1;
      const timerEl = document.getElementById("turnTimer");

      if (timerInterval) clearInterval(timerInterval);

      const validStatuses = ["Lobby", "InTurn", "Processing"];

      if (!validStatuses.includes(state.status)) {
        timerEl.textContent = "0 sec";
        return;
      }

      const updateTimer = () => {
        if (state.status === "Lobby" && state.lobby?.waitTime !== undefined && state.lobby.waitTime !== null) {
          timerEl.textContent = state.lobby.waitTime + " sec";
        } else if (currentRound?.startTimestamp) {
          const elapsed = Math.floor((Date.now() - currentRound.startTimestamp) / 1000);
          timerEl.textContent = elapsed + " sec";
        } else {
          timerEl.textContent = "-";
        }
      };

      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function handleNewGame(gameState) {
      const currentRound = getCurrentRound(gameState);
      const turn = currentRound?.turn ?? 0;
      const isNewGame = turn < lastTurnNumber;
      if (isNewGame) {
        document.getElementById("log").innerHTML = "";
        actionHistory = {};
      }
      lastTurnNumber = turn;
    }

    function updateActionLog(players) {
      Object.entries(players).forEach(([username, player]) => {
        if (player.lastAction && actionHistory[username] !== player.lastAction) {
          actionHistory[username] = player.lastAction;
          addLog(`${username} → ${player.lastAction.toUpperCase()}`);
        }
      });
    }

    const evtSource = new EventSource("/players-stream");

    evtSource.onopen = () => {
      addLog("Bağlantı kuruldu.");
    };

    evtSource.onerror = (err) => {
      addLog("Bağlantı hatası! Yeniden bağlanmaya çalışılıyor...");
    };

    evtSource.onmessage = (event) => {
      if (!event.data) return;

      const data = JSON.parse(event.data);
      // gameState property’si yoksa, doğrudan data kullan
      const gameState = data.gameState || data;

      if (!gameState || !gameState.rounds) {
        console.log("data:", data);
        addLog("Hatalı veya eksik gameState verisi geldi!");
        return;
      }

      const currentRound = getCurrentRound(gameState);

      renderPlayers(gameState.lobby?.players || {}, currentRound?.pairs || {});
      updateGameInfo(gameState);
      handleNewGame(gameState);
      updateActionLog(gameState.lobby?.players || {});

      if (data.systemMessage) addLog(data.systemMessage);
    };
  </script>
</body>

</html>