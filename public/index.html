<!DOCTYPE html>
<html>

<head>
  <title>RPG GÃ¶zlemci Paneli</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
    }

    button {
      margin: 5px;
      padding: 10px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin: 5px 0;
    }

    .player {
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
  <h1>ðŸ§™ RPG GÃ¶zlemci Paneli</h1>

  <div>
    <strong>Oyun Durumu:</strong> <span id="gameStatus"></span><br>
    <strong>Tur:</strong> <span id="turnNumber"></span><br>
    <strong>Tur SÃ¼resi:</strong> <span id="turnTimer"></span> saniye
  </div>

  <h3>Oyuncular</h3>
  <ul id="playerList"></ul>

  <h3>Hamle Logu</h3>
  <div id="log" style="background:#222; padding:10px; height:150px; overflow:auto;"></div>

  <script>
    let turnStartTimestamp = null;
    const actionHistory = {};

    function renderPlayers(players) {
      const list = document.getElementById("playerList");
      list.innerHTML = "";

      for (const [username, data] of Object.entries(players)) {
        const li = document.createElement("li");
        li.className = "player";
        li.innerHTML = `
          <strong>${username}</strong> (${data.class})<br>
          HP: ${data.stats.hp} | ATK: ${data.stats.atk} | DEF: ${data.stats.def}<br>
          <em>Son Hamle:</em> ${data.lastAction}
        `;
        list.appendChild(li);
      }
    }

    function updateLogWithNewActions(players) {
      for (const [username, data] of Object.entries(players)) {
        if (actionHistory[username] !== data.lastAction && data.lastAction !== "Beklemede") {
          actionHistory[username] = data.lastAction;
          addLog(`${username} â†’ ${data.lastAction.toUpperCase()}`);
        }
      }
    }

    function updateGameState(gameState) {
      document.getElementById("gameStatus").textContent = gameState.status;
      document.getElementById("turnNumber").textContent = gameState.turn;
      turnStartTimestamp = gameState.turnStartTimestamp;
      updateTurnTimer();
    }

    function updateTurnTimer() {
      if (!turnStartTimestamp) {
        document.getElementById("turnTimer").textContent = "0";
        return;
      }
      const elapsed = Math.floor((Date.now() - turnStartTimestamp) / 1000);
      document.getElementById("turnTimer").textContent = elapsed;
    }

    function addLog(msg) {
      const log = document.getElementById("log");
      const line = document.createElement("div");
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    async function fetchInitialData() {
      try {
        const res = await fetch("/players");
        const data = await res.json();
        renderPlayers(data.players);
        updateGameState(data.gameState);
      } catch (e) {
        console.error("Ä°lk veri Ã§ekilemedi:", e);
      }
    }

    fetchInitialData();

    const evtSource = new EventSource("/players-stream");

    evtSource.onmessage = (event) => {
      const data = JSON.parse(event.data);
      renderPlayers(data.players);
      updateGameState(data.gameState);
      updateLogWithNewActions(data.players);
    };

    setInterval(updateTurnTimer, 1000);
  </script>
</body>

</html>